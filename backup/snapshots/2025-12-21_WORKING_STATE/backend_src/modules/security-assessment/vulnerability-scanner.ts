import { Vulnerability } from '../../types';
import si from 'systeminformation';

// Mock vulnerability scanner (versione semplificata MVP)
export async function scanVulnerabilities(): Promise<Vulnerability[]> {
  const vulnerabilities: Vulnerability[] = [];

  try {
    // Get software installato
    const versions = await si.versions();

    // Check versioni obsolete comuni (esempio)
    const vulnerableSoftware = [
      { name: 'openssl', oldVersion: '1.0', severity: 'critical' as const },
      { name: 'node', oldVersion: '14', severity: 'high' as const },
      { name: 'npm', oldVersion: '6', severity: 'high' as const }
    ];

    Object.entries(versions).forEach(([name, version]) => {
      vulnerableSoftware.forEach(vuln => {
        if (name.toLowerCase().includes(vuln.name)) {
          if ((version as string).includes(vuln.oldVersion)) {
            vulnerabilities.push({
              id: `VULN-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
              severity: vuln.severity,
              software: name,
              version: version as string,
              description: `Versione obsoleta di ${vuln.name} rilevata`,
              recommendation: `Aggiorna ${vuln.name} all'ultima versione`
            });
          }
        }
      });
    });

    return vulnerabilities;
  } catch (error) {
    console.error('Error scanning vulnerabilities:', error);
    return [];
  }
}
